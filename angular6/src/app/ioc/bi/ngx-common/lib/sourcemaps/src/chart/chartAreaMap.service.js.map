{"version":3,"sources":["src/chart/chartAreaMap.service.ts"],"names":[],"mappings":"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","file":"../../../src/chart/chartAreaMap.service.js","sourcesContent":["import { Injectable } from '@angular/core';\r\nimport * as _ from 'lodash';\r\nimport { Render } from './render';\r\nimport { ActivatedRoute } from '@angular/router';\r\nvar echarts = require('echarts');\r\n\r\n@Injectable()\r\n\r\nexport class ChartAreaMapService {\r\n    constructor(private activatedRoute: ActivatedRoute) {\r\n    }\r\n\r\n    public render(containerDom, option, scope, persist, drill, relations, chartConfig) {\r\n        let render = new Render(containerDom, option);\r\n\r\n        render.addClick(chartConfig, relations, this.activatedRoute);\r\n\r\n        return render.chart(null, persist);\r\n    };\r\n\r\n    public parseOption(data) {\r\n        let self = this;\r\n        var chartConfig = data.chartConfig;\r\n        var casted_keys = data.keys;\r\n        var casted_values = data.series;\r\n        var aggregate_data = data.data;\r\n        var tunningOpt = chartConfig.option;\r\n\r\n        var code = 'china';\r\n        if (chartConfig.city && chartConfig.city.code) {\r\n            code = chartConfig.city.code;\r\n        } else if (chartConfig.province && chartConfig.province.code) {\r\n            code = chartConfig.province.code;\r\n        }\r\n        var url, zoomLevel;\r\n        if (code == 'china') {\r\n            url = 'assets/plugins/FineMap/mapdata/china.json'\r\n            zoomLevel = 1;\r\n        } else if (code.length > 2) {\r\n            zoomLevel = 3;\r\n            url = 'assets/plugins/FineMap/mapdata/geometryCouties/' + code + '.json';\r\n        } else {\r\n            zoomLevel = 2;\r\n            url = 'assets/plugins/FineMap/mapdata/geometryProvince/' + code + '.json';\r\n        }\r\n        var mapOption = null;\r\n        var groups = _.map(casted_values, function (val) {\r\n            return val.join(\"-\")\r\n        });\r\n        var series: any = [];\r\n        for (var i = 0; i < groups.length; i++) {\r\n            let data = [];\r\n            for (var j = 0; j < aggregate_data[i].length; j++) {\r\n                var rawName = casted_keys[j][chartConfig.keys.length - 1];\r\n                var name = !tunningOpt.hasSuffix ? self.processLocName(rawName, zoomLevel) : rawName;\r\n                let e = {name: name, value: aggregate_data[i][j] ? aggregate_data[i][j] : 0};\r\n                data.push(e);\r\n            }\r\n            let e = {\r\n                name: groups[i],\r\n                type: 'map',\r\n                map: code,\r\n                label: {\r\n                    normal: {\r\n                        show: false\r\n                    },\r\n                    emphasis: {\r\n                        show: true\r\n                    }\r\n                },\r\n                itemStyle: {\r\n                    normal: {\r\n                        areaColor: '#EFF0F0',\r\n                        borderColor: '#B5B5B5',\r\n                        borderWidth: 1\r\n                    }\r\n                },\r\n                data: data\r\n            };\r\n            series.push(e);\r\n        }\r\n        var totals = [];\r\n        for (var i = 0; i < casted_values.length; i++) {\r\n            var total = 0;\r\n            for(var j=0;j<aggregate_data[i].length;j++){\r\n                total += parseFloat(!isNaN(aggregate_data[i][j]) ? aggregate_data[i][j]:0);\r\n            }\r\n            totals.push(total);\r\n        }\r\n        totals.sort(function (a, b) {\r\n            return a - b;\r\n        });\r\n        var max = totals[totals.length - 1];\r\n        $.ajax({\r\n            type: \"get\",\r\n            url: url,\r\n            async: false,\r\n            success: function (cityJson) {\r\n                echarts.registerMap(code, cityJson);\r\n                let nameMap = {};\r\n                if(series&&series[0]&&series[0].data&&series[0].data.length) {\r\n                    _.map(cityJson.features, (itemValue: any, key: number) => {\r\n                        nameMap[itemValue.properties.name] = series[0].data[key].name;\r\n                    })\r\n                }\r\n                mapOption = {\r\n                    legend: {\r\n                        orient: 'vertical',\r\n                        left: 'left',\r\n                        data: groups\r\n                    },\r\n                    tooltip: {\r\n                        trigger: 'item',\r\n                        formatter: '{b}: {c}'\r\n                    },\r\n                    visualMap: {\r\n                        min: 0,\r\n                        max: max,\r\n                        left: 'right',\r\n                        top: 'bottom',\r\n                        text: ['High', 'Low'],\r\n                        inRange: {\r\n                            color: ['#e0ffff', '#006edd']\r\n                        },\r\n                        calculable: true\r\n                    },\r\n                    series: series,\r\n                    nameMap: nameMap\r\n                };\r\n            }\r\n        });\r\n        return mapOption;\r\n    };\r\n\r\n    public processLocName(rawName, zoomLevel) {\r\n        var result = rawName;\r\n        var suffixList = ['省', '市', '县', '区'];\r\n        var needProcess = true;\r\n        _.each(suffixList, function (suffix) {\r\n            if (rawName.indexOf(suffix) >= 0) {\r\n                needProcess = false;\r\n            }\r\n        });\r\n        if (!needProcess) {\r\n            return rawName;\r\n        }\r\n        var trimedName = rawName.replace(/省|市|县|区|特别行政/gi, '');\r\n        var zxs = ['北京', '上海', '天津', '重庆'];\r\n        var suffix;\r\n        switch (zoomLevel) {\r\n            case 1:\r\n                if (_.includes(zxs, trimedName )) {\r\n                    suffix = '市';\r\n                } else {\r\n                    suffix = '省';\r\n                }\r\n                break;\r\n            case 2:\r\n                if (_.includes(zxs, trimedName )) {\r\n                    suffix = '区';\r\n                } else {\r\n                    suffix = '市';\r\n                }\r\n                break;\r\n        }\r\n        return result + suffix;\r\n    }\r\n}"]}